<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>QuickNote å‰ç«¯</title>
<style>
  :root {
    --bg-color: #f0f4ff;
    --card-bg: #ffffff;
    --text-color: #333;
    --input-bg: #fff;
    --border-color: #ccc;
    --button-bg: #007bff;
    --button-hover: #0056b3;
  }

  body.dark {
    --bg-color: #1e1e2f;
    --card-bg: #2c2c3e;
    --text-color: #eee;
    --input-bg: #3a3a4f;
    --border-color: #555;
    --button-bg: #4e88ff;
    --button-hover: #3661c9;
  }

  * {
    box-sizing: border-box;
  }

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: var(--bg-color);
    margin: 0;
    padding: 40px 20px;
    display: flex;
    justify-content: center;
    color: var(--text-color);
    transition: background 0.3s, color 0.3s;
    min-height: 100vh;
  }

  #container {
    max-width: 400px;
    width: 100%;
    padding: 25px 30px 40px 30px;
    border: 1px solid var(--border-color);
    border-radius: 12px;
    background-color: var(--card-bg);
    box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    position: relative;
  }

  h2 {
    text-align: center;
    margin-bottom: 25px;
  }
  h3 {
    margin-top: 30px;
    margin-bottom: 12px;
    text-align: center;
    font-weight: 600;
  }

  input, textarea {
    width: 100%;
    padding: 10px 12px;
    margin: 8px 0 15px 0;
    border: 1.5px solid var(--border-color);
    border-radius: 8px;
    font-size: 15px;
    background: var(--input-bg);
    color: var(--text-color);
    transition: border-color 0.3s;
    resize: vertical;
    font-family: inherit;
  }

  input:focus, textarea:focus {
    outline: none;
    border-color: var(--button-bg);
  }

  button {
    width: 100%;
    background-color: var(--button-bg);
    color: white;
    border: none;
    padding: 12px 0;
    margin: 12px 0 0 0;
    border-radius: 8px;
    font-size: 17px;
    cursor: pointer;
    transition: background-color 0.3s;
    font-weight: 600;
  }

  button:hover {
    background-color: var(--button-hover);
  }

  #theme-toggle {
    position: absolute;
    top: 15px;
    right: 15px;
    background: transparent;
    border: 1.5px solid var(--border-color);
    padding: 6px 12px;
    font-size: 14px;
    color: var(--text-color);
    border-radius: 8px;
    width: auto;
    cursor: pointer;
    transition: background-color 0.3s, color 0.3s;
  }
  #theme-toggle:hover {
    background-color: var(--button-bg);
    color: white;
    border-color: var(--button-bg);
  }

  .note-item {
    border: 1px solid var(--border-color);
    padding: 14px 16px;
    border-radius: 10px;
    margin-top: 15px;
    background: var(--input-bg);
    word-break: break-word;
  }

  .note-item pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    margin: 8px 0;
  }

  .note-item button {
    margin-right: 10px;
    width: auto;
    padding: 6px 14px;
    font-size: 14px;
  }

  .hidden {
    display: none;
  }

  #notes-list {
    margin-top: 18px;
  }
</style>
</head>
<body>

<div id="container">
  <button id="theme-toggle" onclick="toggleTheme()">åˆ‡æ¢ä¸»é¢˜ğŸŒ™ /â˜€ï¸ </button>
  <h2>QuickNote</h2>

  <div id="auth-section">
    <h3>æ³¨å†Œ</h3>
    <input id="register-username" placeholder="ç”¨æˆ·å" autocomplete="off" />
    <input id="register-password" type="password" placeholder="å¯†ç " autocomplete="off" />
    <button onclick="register()">æ³¨å†ŒğŸ†• </button>

    <h3>ç™»å½•</h3>
    <input id="login-username" placeholder="ç”¨æˆ·å" autocomplete="off" />
    <input id="login-password" type="password" placeholder="å¯†ç " autocomplete="off" />
    <button onclick="login()">ç™»å½•ğŸ‘¤</button>
  </div>

  <div id="app-section" class="hidden">
    <button onclick="logout()">é€€å‡ºç™»å½•ğŸ˜ŠğŸ‘‹ </button>

    <h3>æ–°å»ºç¬”è®°</h3>
    <input id="note-title" placeholder="æ ‡é¢˜" />
    <textarea id="note-content" placeholder="å†…å®¹" rows="4"></textarea>
    <button onclick="createNote()">æ·»åŠ ç¬”è®°ğŸ“</button>

    <h3>ç¬”è®°åˆ—è¡¨</h3>
    <input type="text" id="search-keyword" placeholder="è¾“å…¥æ ‡é¢˜å…³é”®è¯æœç´¢ç¬”è®°" />
    <button onclick="searchNotes()">ğŸ” æœç´¢</button> 
    <div id="notes-list"></div>
  </div>
</div>

<script>
const API_BASE = 'http://localhost:8080';

// ä¿å­˜ JWT Token
function saveToken(token) {
  localStorage.setItem('token', token);
}

function getToken() {
  return localStorage.getItem('token');
}

function clearToken() {
  localStorage.removeItem('token');
}

function setAuthVisible(visible) {
  document.getElementById('auth-section').style.display = visible ? 'block' : 'none';
  document.getElementById('app-section').style.display = visible ? 'none' : 'block';
}

// æ³¨å†Œ
async function register() {
  const username = document.getElementById('register-username').value.trim();
  const password = document.getElementById('register-password').value.trim();
  if (!username || !password) {
    alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
    return;
  }
  try {
    const res = await fetch(`${API_BASE}/register`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({username, password}),
    });
    if (res.ok) {
      alert('æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•');
    } else {
      const text = await res.text();
      alert('æ³¨å†Œå¤±è´¥: ' + text);
    }
  } catch(e) {
    alert('è¯·æ±‚å¤±è´¥: ' + e.message);
  }
}

// ç™»å½•
async function login() {
  const username = document.getElementById('login-username').value.trim();
  const password = document.getElementById('login-password').value.trim();
  if (!username || !password) {
    alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
    return;
  }
  try {
    const res = await fetch(`${API_BASE}/login`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({username, password}),
    });
    if (res.ok) {
      const token = await res.text();
      saveToken(token);
      alert('ç™»å½•æˆåŠŸ');
      setAuthVisible(false);
      loadNotes();
    } else {
      const text = await res.text();
      alert('ç™»å½•å¤±è´¥: ' + text);
    }
  } catch(e) {
    alert('è¯·æ±‚å¤±è´¥: ' + e.message);
  }
}

// ç™»å‡º
function logout() {
  clearToken();
  setAuthVisible(true);
  document.getElementById('notes-list').innerHTML = '';
}

async function loadNotes(keyword = '') {
  const token = getToken();
  if (!token) return;
  try {
    let url = `${API_BASE}/api/notes`;
    if (keyword) {
      url += `?keyword=${encodeURIComponent(keyword)}`;
    }
    const res = await fetch(url, {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    if (res.ok) {
      const notes = await res.json();
      displayNotes(notes);
    } else {
      alert('åŠ è½½ç¬”è®°å¤±è´¥');
    }
  } catch(e) {
    alert('è¯·æ±‚å¤±è´¥: ' + e.message);
  }
}


// æ˜¾ç¤ºç¬”è®°
function displayNotes(notes) {
  const container = document.getElementById('notes-list');
  container.innerHTML = '';
  notes.forEach(note => {
    const div = document.createElement('div');
    div.className = 'note-item';
    div.innerHTML = `
      <strong>${escapeHtml(note.title)}</strong><br/>
      <pre>${escapeHtml(note.content)}</pre>
      <button onclick="editNote(${note.id}, '${escapeHtml(note.title)}', '${escapeHtml(note.content)}')">ç¼–è¾‘âœï¸</button>
      <button onclick="deleteNote(${note.id})">åˆ é™¤ğŸ—‘ï¸</button>
    `;

    container.appendChild(div);
  });
}

// åˆ›å»ºç¬”è®°
async function createNote() {
  const title = document.getElementById('note-title').value.trim();
  const content = document.getElementById('note-content').value.trim();
  if (!title || !content) {
    alert('è¯·å¡«å†™æ ‡é¢˜å’Œå†…å®¹');
    return;
  }
  const token = getToken();
  if (!token) {
    alert('è¯·å…ˆç™»å½•');
    return;
  }
  try {
    const res = await fetch(`${API_BASE}/api/notes`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      },
      body: JSON.stringify({title, content})
    });
    if (res.ok) {
      alert('ç¬”è®°åˆ›å»ºæˆåŠŸ');
      document.getElementById('note-title').value = '';
      document.getElementById('note-content').value = '';
      loadNotes();
    } else {
      const text = await res.text();
      alert('åˆ›å»ºå¤±è´¥: ' + text);
    }
  } catch(e) {
    alert('è¯·æ±‚å¤±è´¥: ' + e.message);
  }
}

// ç¼–è¾‘ç¬”è®°
function editNote(id, oldTitle, oldContent) {
  const newTitle = prompt("ä¿®æ”¹æ ‡é¢˜:", oldTitle);
  if (newTitle === null) return; // ç”¨æˆ·å–æ¶ˆ

  const newContent = prompt("ä¿®æ”¹å†…å®¹:", oldContent);
  if (newContent === null) return;

  updateNote(id, newTitle, newContent);
}

// æ›´æ–°ç¬”è®°
async function updateNote(id, title, content) {
  const token = getToken();
  if (!token) {
    alert('è¯·å…ˆç™»å½•');
    return;
  }
  try {
    const res = await fetch(`${API_BASE}/api/notes/${id}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      },
      body: JSON.stringify({title, content})
    });
    if (res.ok) {
      alert('ç¬”è®°æ›´æ–°æˆåŠŸ');
      loadNotes();
    } else {
      const text = await res.text();
      alert('æ›´æ–°å¤±è´¥: ' + text);
    }
  } catch(e) {
    alert('è¯·æ±‚å¤±è´¥: ' + e.message);
  }
}

// åˆ é™¤ç¬”è®°
async function deleteNote(id) {
  const token = getToken();
  if (!token) {
    alert('è¯·å…ˆç™»å½•');
    return;
  }
  if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ç¬”è®°å—ï¼Ÿ')) return;

  try {
    const res = await fetch(`${API_BASE}/api/notes/${id}`, {
      method: 'DELETE',
      headers: { 'Authorization': 'Bearer ' + token }
    });
    if (res.ok) {
      alert('åˆ é™¤æˆåŠŸ');
      loadNotes();
    } else {
      alert('åˆ é™¤å¤±è´¥');
    }
  } catch(e) {
    alert('è¯·æ±‚å¤±è´¥: ' + e.message);
  }
}

// é˜²æ­¢XSS
function escapeHtml(text) {
  return text
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

// é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦ç™»å½•
window.onload = () => {
  if (getToken()) {
    setAuthVisible(false);
    loadNotes();
  } else {
    setAuthVisible(true);
  }
};

function toggleTheme() {
  document.body.classList.toggle('dark');
}

function searchNotes() {
  const keyword = document.getElementById('search-keyword').value;
  loadNotes(keyword);
}

</script>

</body>
</html>
